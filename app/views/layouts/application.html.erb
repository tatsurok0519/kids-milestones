<!DOCTYPE html>
<html>
  <head>
    <title>こどもすくすくカード</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <script>window.__SIGNED_IN__ = <%= user_signed_in? ? 'true' : 'false' %>;</script>
  </head>
  <body>
    <!-- 共通ヘッダー -->
    <%= render "shared/header" %>

    <!-- パンくず（設定があるときだけ） -->
    <%= render("shared/breadcrumbs") if defined?(breadcrumb_trail) && breadcrumb_trail.present? %>

    <%= image_tag "illustrations/watering.png", alt: "水やり", class: "watering-illustration" %>

    <% flash.each do |k, v| %>
      <div class="container" style="margin-top:1rem">
        <div class="flash <%= k %>"><%= v %></div>
      </div>
    <% end %>

    <main class="container main" style="padding:1.5rem 0">
      <%= yield %>
    </main>

    <!-- フッター（パーシャル） -->
    <%= render "shared/footer" %>

    <!-- トーストレイヤ -->
    <div id="toasts" class="toast-layer" aria-live="polite" aria-atomic="true"></div>
    <div id="reward_animator" hidden aria-hidden="true"></div>

    <%# 新規ごほうびが直前の操作で解放されていたら、次ページロード時に演出を起動 %>
    <% if @reward_boot_ids.present? %>
      <script>
        document.addEventListener('turbo:load', function onBootOnce(){
          document.removeEventListener('turbo:load', onBootOnce, { once: true });
          const ids = <%= @reward_boot_ids.map(&:to_i).to_json %>;
          if (ids.length) {
            document.dispatchEvent(new CustomEvent('reward:unlocked', { detail: { ids } }));
          }
        }, { once: true });
      </script>
    <% end %>
  </body>
</html>