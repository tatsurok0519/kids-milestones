<!-- 子ども一覧（全員表示・タップで切替） -->
  <div class="card" style="margin-bottom:.75rem;">
    <div class="h2" style="font-size:1.1rem;margin:0 0 .5rem;">お子さま</div>

    <% if @children.any? %>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem;">
        <% @children.each do |kid| %>
          <% is_active = @selected_child && kid.id == @selected_child.id %>
          <%= link_to dashboard_path(child_id: kid.id),
                      class: "child-card#{' is-active' if is_active}",
                      style: "display:flex;gap:.6rem;align-items:center;border:1px solid var(--border);border-radius:.8rem;padding:.6rem;background:#fff;text-decoration:none;color:inherit;" do %>

            <div style="flex:none;">
              <% if kid.photo.attached? %>
                <%= attachment_img kid.photo,
                      variant: kid.photo_thumb, width: 56, height: 56,
                      alt: "#{kid.name}の写真",
                      style: "width:56px;height:56px;object-fit:cover;border-radius:.6rem;border:1px solid var(--border);" %>
              <% else %>
                <%= asset_img "illustrations/sun.png", width: 56, height: 56, alt: "",
                      style: "border-radius:.6rem;border:1px solid var(--border);background:#f3f4f6;" %>
              <% end %>
            </div>

            <div style="min-width:0;">
              <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"><%= kid.name %></div>
              <div class="text-muted" style="font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                <%= kid.age_label %> / <%= kid.age_band_label %>
              </div>
              <div style="margin-top:.25rem;">
                <span class="pill">花丸 <%= (@achieved_counts[kid.id] || 0) %></span>
              </div>
            </div>

            <% if is_active %>
              <span class="pill" aria-hidden="true" style="margin-left:auto;background:#e6f4ff;border-color:#9acbff;">選択中</span>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p style="margin:0 0 .5rem;">まだお子さまの登録がありません。</p>
      <%= link_to "子どもを追加", new_child_path, class: "btn btn-primary" %>
    <% end %>
  </div>

  <!-- 選択中の子の概要 -->
  <% if @child %>
    <div class="card" style="margin-bottom:.75rem;">
      <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
        <div style="flex:none;">
          <% if @child.photo.attached? %>
            <%= attachment_img @child.photo,
                  variant: @child.photo_card, width: 96, height: 96,
                  alt: "#{@child.name}の写真",
                  loading: "eager", fetchpriority: "high",
                  style: "width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid var(--border);" %>
          <% else %>
            <%= asset_img "illustrations/sun.png",
                  width: 96, height: 96, alt: "",
                  loading: "eager", fetchpriority: "high",
                  style: "border-radius:12px;border:1px solid var(--border);background:#f3f4f6;" %>
          <% end %>
        </div>

        <div style="min-width:200px; flex:1 1 auto;">
          <h2 class="h2" style="margin:0 0 .25rem 0;">ダッシュボード</h2>
          <div class="h2" style="font-size:1.1rem;margin:0;">
            <strong><%= @child.name %></strong> さん
          </div>

          <!-- チップ + ごほうび を同じ行に。 -->
          <div class="rewards-line" style="display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; margin-top:.35rem;">
            <!-- チップ行（常に先頭に並べる） -->
            <div class="chips-row" style="display:flex; gap:.5rem; flex-wrap:wrap;">
              <span class="pill"><%= current_child.age_label %></span>
              <span class="pill"><%= current_child.age_band_label %></span>
              <span class="pill">花丸 <%= current_child.achieved_count %></span>
            </div>
            <%= render "dashboard/rewards_row" %>  <!-- ← アイコン側は data-reward-id を付与しておく -->
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <% if @children.any? %>
      <div class="card" style="margin-bottom:.75rem;">
        <p style="margin:0;">上の一覧からお子さまを選んでください。</p>
      </div>
    <% end %>
  <% end %>

  <!-- 今日の子育てメッセージ -->
  <div class="card" style="margin:-.25rem 0 .75rem 0; border:1px solid #cce7ff; background:#f5fbff;">
    <div style="display:flex; gap:.6rem; align-items:flex-start;">
      <%= asset_img "illustrations/sun.png", width: 24, height: 24, alt: "",
            style: "flex:none; margin-top:.1rem;" %>
      <div>
        <div class="label" style="font-weight:700; margin-bottom:.2rem;">今日の子育てメッセージ</div>
        <div style="line-height:1.6;"><%= @parent_tip %></div>
      </div>
    </div>
  </div>

  <!-- 主要リンク -->
  <div class="card" style="padding:.75rem;">
    <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
      <%= link_to "できるかな一覧へ", tasks_path, class: "btn btn-primary" %>
      <%= link_to "子育てそうだんへ", consult_path, class: "btn btn-primary" %>

      <% if @child %>
        <%= link_to "レポート（印刷）へ", child_report_path(@child), class: "btn btn-primary" %>
      <% else %>
        <%# 子ども未選択時の誘導（必要なら） %>
        <%= link_to "レポート（印刷）へ", children_path, class: "btn btn-primary" %>
      <% end %>

      <%= link_to "マイページ", account_path, class: "btn" %>
    </div>
  </div>
</div>

<%# --- ごほうび演出ブート + 既読ACK（非破壊公開→見終わったら既読） --- %>
<% if @reward_boot_ids.present? %>
  <div id="reward-boot" data-ids="<%= @reward_boot_ids.join(',') %>"></div>
  <%= javascript_tag do %>
    document.addEventListener("turbo:load", () => {
      const boot = document.getElementById("reward-boot");
      if (!boot) return;
      const ids = (boot.dataset.ids || "").split(",").filter(Boolean);

      // アイコンに発光アニメを付与（アイコン側は data-reward-id にIDを持たせておく）
      ids.forEach((id) => {
        document.querySelectorAll(`[data-reward-id="${id}"]`).forEach((el) => {
          el.classList.add("reward-glow");
        });
      });

      // 見終わったら既読（部分既読：今回表示分のみ）
      fetch("<%= ack_rewards_path(format: :json) %>", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ ids: ids })
      }).catch(() => {});
    });
  <% end %>
<% end %>