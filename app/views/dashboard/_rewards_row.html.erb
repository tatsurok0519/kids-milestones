<%
  the_child =
    if local_assigns.key?(:child)
      child
    elsif defined?(current_child)
      current_child
    end

  achieved_count = the_child&.achievements&.where(achieved: true)&.count.to_i

  items =
    if achieved_count.positive?
      Reward.where("threshold <= ?", achieved_count)
            .ordered              # CASE kind(0/1/2), threshold, id
            .to_a
            .uniq(&:id)           # ★ kind ではなく id で一意化（安全）
    else
      []
    end

  size_map = {
    "medal"   => { "bronze" => 48, "silver" => 56, "gold" => 56 },
    "trophy"  => { "bronze" => 80, "silver" => 80, "gold" => 80 },
    "special" => { "crown" => 84, "decoration" => 84, "hall_of_fame" => 92 }
  }
  default_size = 72
%>

<% if items.any? %>
  <div class="rewards-row"
       style="display:flex; align-items:center; gap:.5rem;
              flex-wrap:nowrap; white-space:nowrap; overflow:visible; margin-left:.5rem;">
    <% items.each do |rw| %>
      <% size = size_map.dig(rw.kind, rw.tier) || default_size %>
      <span id="reward_icon_<%= rw.id %>"
            class="reward-icon"
            data-reward-id="<%= rw.id %>"
            style="width:<%= size %>px; height:<%= size %>px; display:inline-flex;
                   align-items:center; justify-content:center; flex:0 0 auto;">
        <%= asset_img rw.icon_path,
              alt: "",
              width: size, height: size,
              loading: "lazy", decoding: "async",
              style: "max-width:100%; max-height:100%; object-fit:contain; display:block;",
              data: { reward_id: rw.id } %>
      </span>
    <% end %>
  </div>
<% end %>