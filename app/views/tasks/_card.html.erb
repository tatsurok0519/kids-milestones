<% ach = achievement %>

<div class="milestone-card <%= 'is-working'  if ach&.working %> <%= 'is-achieved' if ach&.achieved %>"
     data-id="<%= milestone.id %>"
     style="position:relative;border:1px solid var(--border);border-radius:.8rem;padding:.9rem;background:#fff;">

  <!-- タイトル -->
  <div style="font-weight:700;"><%= milestone.title %></div>

  <!-- ピル群 -->
  <div style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;">
    <span class="pill"><%= milestone.category.presence || "未分類" %></span>
    <span class="pill"><%= milestone.age_band_labels %></span>
    <span class="pill"><%= milestone.difficulty_stars %></span>
  </div>

  <% if user_signed_in? && defined?(current_child) && current_child && !(defined?(@demo_mode) && @demo_mode) %>
    <!-- ログイン時：進捗コントロール -->
    <turbo-frame id="<%= dom_id(milestone, :controls) %>">
      <%= render "tasks/controls", milestone: milestone, achievement: ach %>
    </turbo-frame>
  <% else %>
    <!-- 未ログイン/デモ：右上バッジ -->
    <div class="rw-badge-group" aria-hidden="true"
         style="position:absolute; top:8px; right:8px; pointer-events:none;">
      <%= image_tag 'icons/try.png',  alt: '', class: 'rw-badge rw-badge-try',
            width: 44, height: 44, loading: "lazy", decoding: "async" %>
      <%= image_tag 'icons/hanamaru.png', alt: '', class: 'rw-badge rw-badge-achi',
            width: 44, height: 44, loading: "lazy", decoding: "async" %>
    </div>

    <!-- 未ログイン/デモ：おためし進捗ボタン -->
    <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
      <button class="btn btn-secondary btn-working" type="button">がんばり中</button>
      <button class="btn btn-primary btn-achieved"  type="button">できた！</button>
    </div>
  <% end %>

  <%# ▼▼ ヒント + 小イラスト ▼▼ %>
  <% hint_raw =
       (defined?(milestones_has_hint_text_column?) && milestones_has_hint_text_column? &&
        defined?(milestone_hint_text) ? milestone_hint_text(milestone) : nil) ||
       milestone.try(:description) || "" %>

  <%# サムネ（あるときだけ） %>
  <% thumb = (defined?(task_small_thumb_path) ? task_small_thumb_path(milestone) : nil) %>

  <!-- 1行目：左に小イラスト、右に「ヒント」ボタン -->
  <div style="--thumb: 84px; --gap: .6rem; margin-top:.6rem;">
    <div style="display:flex; align-items:flex-start; gap:var(--gap);">
      <% if thumb.present? %>
        <%= asset_img thumb,
              alt: "",
              width: 84, height: 84, loading: "lazy", decoding: "async",
              style: "flex:none; width:var(--thumb); height:var(--thumb); object-fit:cover;
                      border:1px solid var(--border); border-radius:.6rem; background:#fff;" %>
      <% end %>

      <details class="hint-wrap" style="margin:0;">
        <summary class="btn btn-hint"
                 style="display:inline-flex; border:1px dashed var(--border); cursor:pointer;">
          ヒント
        </summary>

        <!-- 2行目：ヒント本文は“カード幅いっぱい”。
             左にあるサムネぶんを負のマージンで食い込ませて横幅を拡張する -->
        <div class="hint-box"
             style="margin-top:.5rem; padding:.6rem; border:1px dashed var(--border);
                    border-radius:.6rem; background:#fffaf5; color:#7a4a00; font-size:.9rem;
                    margin-left: calc(-1 * (var(--thumb) + var(--gap)));
                    width: calc(100% + var(--thumb) + var(--gap));">
          <% if hint_raw.present? %>
            <%= hint_raw %>
          <% else %>
            <%= simple_format("ヒントは準備中です") %>
          <% end %>
        </div>
      </details>
    </div>
  </div>
  <%# ▲▲ ヒント + 小イラスト ▲▲ %>
</div>