<%# Turbo対応：「がんばり中 / できた！ / 未着手に戻す」 %>
<div>
  <%# 右上バッジ（状態に応じて1つだけ表示）。ゲストは achievement が無いので表示されません。 %>
  <% if achievement&.working %>
    <%= image_tag "icons/try.png", alt: "", width: 48, height: 48,
          style: "position:absolute; top:8px; right:8px; pointer-events:none;" %>
  <% elsif achievement&.achieved %>
    <%= image_tag "icons/hanamaru.png", alt: "", width: 48, height: 48,
          style: "position:absolute; top:8px; right:8px; pointer-events:none;" %>
  <% end %>

  <div style="margin-top:.6rem; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">

    <%# がんばり中 %>
    <%= button_to achievements_upsert_path(milestone_id: milestone.id),
          params: {
            toggle: "working",
            age_band: params[:age_band],
            category: params[:category],
            difficulty: params[:difficulty],
            only_unachieved: params[:only_unachieved],
            page: params[:page] # ← ページ保持
          },
          method: :post,
          form:   { data: { turbo_frame: dom_id(milestone, :controls), progress_form: true } },
          class:  "btn btn-secondary" do %>
      がんばり中
    <% end %>

    <%# できた！ %>
    <%= button_to achievements_upsert_path(milestone_id: milestone.id),
          params: {
            toggle: "achieved",
            age_band: params[:age_band],
            category: params[:category],
            difficulty: params[:difficulty],
            only_unachieved: params[:only_unachieved],
            page: params[:page] # ← ページ保持
          },
          method: :post,
          form:   { data: { turbo_frame: dom_id(milestone, :controls), progress_form: true } },
          class:  "btn btn-primary" do %>
      できた！
    <% end %>

    <%# 未着手に戻す（状態がある時だけ表示） %>
    <% if achievement.present? %>
      <%= button_to achievements_upsert_path(milestone_id: milestone.id),
            params: {
              toggle: "clear",
              age_band: params[:age_band],
              category: params[:category],
              difficulty: params[:difficulty],
              only_unachieved: params[:only_unachieved],
              page: params[:page] # ← ページ保持
            },
            method: :post,
            form:   { data: { turbo_frame: dom_id(milestone, :controls), progress_form: true } },
            class:  "btn" do %>
        未着手に戻す
      <% end %>
    <% end %>

    <%# ヒント（未ログインでも表示）。hint_text が無い場合は出さない。 %>
    <% show_hint = milestone.respond_to?(:hint_text) && milestone.hint_text.present? %>
    <% if show_hint %>
      <%# YAMLフォールバックで id が無い場合も衝突しないように固有IDを作る %>
      <% hint_box_id = "hint_box_#{milestone.id || "demo_#{milestone.title.to_s.parameterize}_#{milestone.object_id}"}" %>

      <button type="button"
              class="btn"
              style="border:1px dashed var(--border);"
              data-hint-toggle
              aria-expanded="false"
              aria-controls="<%= hint_box_id %>">
        ヒント
      </button>
    <% end %>
  </div>

  <%# ヒントパネル（未ログインでも表示） %>
  <% if show_hint %>
    <div id="<%= hint_box_id %>" data-hint-box hidden
         style="margin-top:.5rem; padding:.6rem; border:1px dashed var(--border);
                border-radius:.6rem; background:#fffaf5; color:#7a4a00; font-size:.9rem;">
      <%= simple_format(h(milestone.hint_text)) %>
    </div>
  <% end %>
</div>