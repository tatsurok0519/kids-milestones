<%# === ヒント領域のID（渡されなくても自給） ======================= %>
<% hint_id = (local_assigns[:hint_id] || dom_id(milestone, :hint)) %>
<%# ================================================================ %>

<%# Turbo対応の操作UI。位置合わせ用に position:relative を付与 %>
<div style="position:relative;">
  <%# 右上バッジ（TRY/花丸） %>
  <% if achievement&.working %>
    <%= image_tag "icons/try.png", alt: "", width: 48, height: 48,
          style: "position:absolute; top:8px; right:8px; pointer-events:none;" %>
  <% elsif achievement&.achieved %>
    <%= image_tag "icons/hanamaru.png", alt: "", width: 48, height: 48,
          style: "position:absolute; top:8px; right:8px; pointer-events:none;" %>
  <% end %>

  <div style="margin-top:.6rem; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">

    <%# がんばり中 %>
    <%= button_to achievements_upsert_path(milestone_id: milestone.id),
          params: {
            state: "working",
            child_id: current_child&.id,
            age_band: params[:age_band],
            category: params[:category],
            difficulty: params[:difficulty],
            only_unachieved: params[:only_unachieved],
            page: params[:page]
          },
          method: :post,
          form:   { data: { turbo_frame: dom_id(milestone, :controls), turbo_stream: true, progress_form: true } },
          class:  "btn btn-secondary" do %>
      がんばり中
    <% end %>

    <%# できた！ %>
    <%= button_to achievements_upsert_path(milestone_id: milestone.id),
          params: {
            state: "achieved",
            child_id: current_child&.id,
            age_band: params[:age_band],
            category: params[:category],
            difficulty: params[:difficulty],
            only_unachieved: params[:only_unachieved],
            page: params[:page]
          },
          method: :post,
          form:   { data: { turbo_frame: dom_id(milestone, :controls), turbo_stream: true, progress_form: true } },
          class:  "btn btn-primary" do %>
      できた！
    <% end %>

    <%# 未着手に戻す（状態が存在する時だけ） %>
    <% if achievement.present? %>
      <%= button_to achievements_upsert_path(milestone_id: milestone.id),
            params: {
              state: "clear",
              child_id: current_child&.id,
              age_band: params[:age_band],
              category: params[:category],
              difficulty: params[:difficulty],
              only_unachieved: params[:only_unachieved],
              page: params[:page]
            },
            method: :post,
            form:   { data: { turbo_frame: dom_id(milestone, :controls), turbo_stream: true, progress_form: true } },
            class:  "btn" do %>
        未着手に戻す
      <% end %>
    <% end %>

  </div>
</div>

<%# === ヒント（JS不要の <details> 方式。説明が空でも骨組みは出す） === %>
<details class="hint mt-2">
  <summary class="btn btn-hint">ヒント</summary>
  <div id="<%= hint_id %>" class="hint-panel">
    <%= simple_format(milestone.description.presence || "ヒントは準備中です") %>
  </div>
</details>