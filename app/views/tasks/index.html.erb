<div class="container main">
  <!-- ヘッダー（子ども情報を表示） -->
  <div class="card" style="margin-bottom:1rem;">
    <% if user_signed_in? && current_child %>
      <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
        <% if current_child.photo.attached? %>
          <%= image_tag current_child.photo_card,
                alt: "#{current_child.name}の写真",
                style: "width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid var(--border);" %>
        <% else %>
          <%= image_tag "illustrations/sun.png",
                alt: "", size: "96x96",
                style: "border-radius:12px;border:1px solid var(--border);background:#f3f4f6;" %>
        <% end %>

        <div style="min-width:200px;">
          <h2 class="h2" style="margin:0 0 .25rem 0;">できるかな（標準タスク）</h2>
          <div class="h2" style="font-size:1.1rem;margin:0;">
            <strong><%= current_child.name %></strong> さん
          </div>
          <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.25rem;">
            <span class="pill"><%= current_child.age_label %></span>
            <span class="pill"><%= current_child.age_band_label %></span>
          </div>
        </div>
      </div>

    <% elsif user_signed_in? %>
      <h2 class="h2" style="margin:0;">できるかな（標準タスク）</h2>
      <p style="margin:.25rem 0 0;">
        子どもが未選択です。
        <%= link_to "子どもを追加", new_child_path, class: "btn btn-primary" %>
        <%= link_to "既存の子を選ぶ", children_path, class: "btn btn-secondary", style: "margin-left:.5rem;" %>
      </p>

    <% else %>
      <h2 class="h2" style="margin:0;">できるかな（標準タスク）</h2>
      <p style="margin:.25rem 0 0;">
        ログインなしの「おためしモード」です。進捗はこの端末（ブラウザ）のみ保存されます。
        <%= link_to "保存やレポートを使うには登録", new_user_registration_path, class: "btn btn-primary", style: "margin-left:.5rem;" %>
      </p>
    <% end %>
  </div>

  <!-- フィルター -->
  <div class="card" style="padding:.75rem;margin-bottom:.75rem;">
    <%= form_with url: tasks_path, method: :get, local: true,
          html: { style: "display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;" } do %>

      <label class="label" for="age_band">年齢帯</label>
      <%= select_tag :age_band,
            options_for_select((0..5).map { |i| ["#{i}–#{i+1}歳", i] }, @age_band_index),
            class: "input",
            onchange: "this.form.submit()" %>

      <label class="label" for="category">カテゴリ</label>
      <%= select_tag :category,
            options_for_select([["すべて", ""]] + @categories.map { |c| [c, c] }, params[:category].to_s),
            class: "input",
            onchange: "this.form.submit()" %>

      <label class="label" for="difficulty">難易度</label>
      <%= select_tag :difficulty,
            options_for_select([["すべて", ""]] + @difficulties, params[:difficulty].to_s),
            class: "input",
            onchange: "this.form.submit()" %>

      <!-- 未達成のみ（ログイン＆子選択時のみ有効） -->
      <label class="label" for="only_unachieved" style="display:flex;align-items:center;gap:.35rem;">
        <%= check_box_tag :only_unachieved, "1", @only_unachieved,
              onchange: "this.form.submit()",
              disabled: !(user_signed_in? && current_child) %>
        未達成のみ
      </label>

      <% if current_user && current_child %>
        <span class="pill" style="margin-left:.25rem;">
          選択中：<strong><%= current_child.name %></strong>
          （<%= current_child.age_label %> / <%= current_child.age_band_label %>）
        </span>
      <% end %>
    <% end %>
  </div>

  <!-- 一覧 -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;">
      <div class="h2" style="font-size:1.1rem;margin:0;">
        標準タスク（<%= @age_band_label %>）
      </div>
      <div class="text-muted" style="font-size:.9rem;">該当 <%= @milestones.size %> 件</div>
    </div>

    <hr class="divider">

    <% if @milestones.any? %>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
        <% @milestones.each do |ms| %>
          <% ach = (defined?(@ach_by_ms) && @ach_by_ms) ? @ach_by_ms[ms.id] : nil %>

          <div class="milestone-card <%= 'is-working'  if ach&.working %> <%= 'is-achieved' if ach&.achieved %>"
               data-id="<%= ms.id %>"
               style="position:relative;border:1px solid var(--border);border-radius:.8rem;padding:.9rem;background:#fff;">

            <div style="font-weight:700;"><%= ms.title %></div>
            <div style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;">
              <span class="pill"><%= ms.category.presence || "未分類" %></span>
              <span class="pill"><%= ms.age_band_labels %></span>
              <span class="pill"><%= ms.difficulty_stars %></span>
            </div>

            <% if user_signed_in? && current_child %>
              <!-- ログイン時：Turbo Frame でコントロールをラップ -->
              <turbo-frame id="<%= dom_id(ms, :controls) %>">
                <%= render "tasks/controls", milestone: ms, achievement: ach %>
              </turbo-frame>
            <% else %>
              <!-- 未ログイン時：右上バッジは常設してCSSで切替（JSが is-* を付け外し） -->
              <div class="badge-group" aria-hidden="true"
                   style="position:absolute; top:8px; right:8px; pointer-events:none;">
                <%= image_tag 'icons/try.png',      alt: '', class: 'badge badge-try',  width: 44, height: 44 %>
                <%= image_tag 'icons/hanamaru.png', alt: '', class: 'badge badge-achi', width: 44, height: 44 %>
              </div>

              <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
                <button class="btn btn-secondary btn-working" type="button">がんばり中</button>
                <button class="btn btn-primary btn-achieved"  type="button">できた！</button>
                <button class="btn" style="border:1px dashed var(--border);" type="button"
                        data-hint-toggle aria-expanded="false">ヒント</button>
              </div>

              <!-- ヒントパネル -->
              <div data-hint-box hidden
                   style="margin-top:.5rem;padding:.6rem;border:1px dashed var(--border);
                          border-radius:.6rem;background:#fffaf5;color:#7a4a00;font-size:.9rem;">
                <%= ms.hint_text %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p>該当タスクがありません。フィルター条件を変更してください。</p>
    <% end %>
  </div>
</div>

<%# 未ログイン時のみ、おためし保存用のインラインJSとCSSを読み込む %>
<% unless user_signed_in? %>
  <script>
  (function(){
    const KEY = "try_progress_v1";

    function loadState(){ try { return JSON.parse(localStorage.getItem(KEY) || "{}"); } catch(e){ return {}; } }
    function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }

    function renderCard(card, rec){
      card.classList.remove("is-working","is-achieved");
      if (rec?.achieved) {
        card.classList.add("is-achieved");
      } else if (rec?.working) {
        card.classList.add("is-working");
      }
    }

    const state = loadState();
    document.querySelectorAll(".milestone-card").forEach(card => {
      const id = card.getAttribute("data-id");
      renderCard(card, state[id]);

      const workingBtn  = card.querySelector(".btn-working");
      const achievedBtn = card.querySelector(".btn-achieved");
      if(!workingBtn || !achievedBtn) return;

      workingBtn.addEventListener("click", () => {
        state[id] = state[id] || {};
        state[id].working = !state[id].working;
        if (state[id].working) state[id].achieved = false;
        renderCard(card, state[id]); saveState(state);
      });

      achievedBtn.addEventListener("click", () => {
        state[id] = state[id] || {};
        state[id].achieved = !state[id].achieved;
        if (state[id].achieved) state[id].working = false;
        renderCard(card, state[id]); saveState(state);
      });
    });
  })();
  </script>

  <style>
  /* 未ログイン時の右上バッジはCSSで表示切替（JSが .is-working / .is-achieved を付与） */
  .badge { display: none; }
  .milestone-card.is-working  .badge-try  { display: block; }
  .milestone-card.is-achieved .badge-achi { display: block; }
  </style>
<% end %>