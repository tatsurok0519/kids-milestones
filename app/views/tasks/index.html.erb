<h1>できるかな体験</h1>
<% if @milestones.present? %>
  <ul>
    <% @milestones.each do |m| %>
      <li><%= m.title %></li>
    <% end %>
  </ul>
<% else %>
  <p>公開ページです（ログイン不要）。</p>
<% end %>

<div class="card" style="padding: .75rem; margin-bottom: .75rem;">
  <%= form_with url: tasks_path, method: :get, local: true, html: { style: "display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;" } do %>
    <label class="label" for="age_band">年齢帯</label>
    <%= select_tag :age_band,
          options_for_select((0..5).map { |i| ["#{i}–#{i+1}歳", i] }, @age_band_index),
          class: "input",
          onchange: "this.form.submit()" %>

    <% if current_user && current_child %>
      <span class="pill" style="margin-left:.25rem;">
        選択中：<strong><%= current_child.name %></strong>（<%= current_child.age_label %> / <%= current_child.age_band_label %>）
      </span>
    <% end %>
  <% end %>
</div>

<div class="container">
  <div class="card" style="margin-bottom:1rem;">
    <h2 class="h2">できるかな</h2>
    <p style="margin:.25rem 0 0;">
      <% if user_signed_in? %>
        ようこそ、<strong><%= current_user.name.presence || current_user.email %></strong> さん。進捗はアカウントに保存されます。
      <% else %>
        ログインなしの「おためしモード」です。進捗はこの端末（ブラウザ）のみ保存されます。
        <%= link_to "保存やレポートを使うには登録", new_user_registration_path, class: "btn btn-primary", style: "margin-left:.5rem;" %>
      <% end %>
    </p>
  </div>

  <div class="card">
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem;">
      <span class="pill">全項目 <%= Milestone.count %> 件</span>
      <!-- 将来: カテゴリ/難易度フィルタをここに -->
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
      <% Milestone.order(:difficulty, :id).each do |ms| %>
        <div class="milestone-card" data-id="<%= ms.id %>"
             style="border:1px solid var(--border);border-radius:.8rem;padding:.9rem;background:#fff;">
          <div style="font-weight:700;"><%= ms.title %></div>
          <div style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center;">
            <span class="pill"><%= ms.category %></span>
            <span class="pill">★<%= ms.difficulty %></span>
          </div>

          <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn btn-secondary btn-working" type="button">がんばり中</button>
            <button class="btn btn-primary btn-achieved" type="button">花丸！</button>
            <button class="btn" style="border:1px dashed var(--border);" type="button" onclick="alert('メモ機能は後日実装予定です')">メモ</button>
          </div>

          <div class="state-hint" style="margin-top:.5rem;font-size:.85rem;color:var(--muted);"></div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
(function(){
  const KEY = "try_progress_v1"; // localStorageキー（未ログイン用）
  const loggedIn = <%= user_signed_in? ? "true" : "false" %>;

  function loadState(){
    try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
    catch(e){ return {}; }
  }
  function saveState(state){
    localStorage.setItem(KEY, JSON.stringify(state));
  }
  function renderCard(card, rec){
    const hint = card.querySelector(".state-hint");
    card.classList.remove("is-working","is-achieved");
    if(rec?.achieved){
      card.classList.add("is-achieved");
      hint.textContent = "花丸にしました（お試し保存）";
    }else if(rec?.working){
      card.classList.add("is-working");
      hint.textContent = "がんばり中（お試し保存）";
    }else{
      hint.textContent = "";
    }
  }

  const state = loadState();
  document.querySelectorAll(".milestone-card").forEach(card => {
    const id = card.getAttribute("data-id");
    renderCard(card, state[id]);

    const workingBtn = card.querySelector(".btn-working");
    const achievedBtn = card.querySelector(".btn-achieved");

    workingBtn.addEventListener("click", () => {
      if (loggedIn) {
        alert("DB保存は次のステップで実装します（デモ中）");
        return;
      }
      state[id] = state[id] || {};
      state[id].working = !state[id].working;
      if (state[id].working) state[id].achieved = false; // 同時ONは避ける
      renderCard(card, state[id]);
      saveState(state);
    });

    achievedBtn.addEventListener("click", () => {
      if (loggedIn) {
        alert("DB保存は次のステップで実装します（デモ中）");
        return;
      }
      state[id] = state[id] || {};
      state[id].achieved = !state[id].achieved;
      if (state[id].achieved) state[id].working = false;
      renderCard(card, state[id]);
      saveState(state);
    });
  });
})();
</script>

<style>
/* 簡単な見た目の変化（お試しモード用） */
.milestone-card.is-working{ outline: 3px solid rgba(127,184,167,.25); }
.milestone-card.is-achieved{ outline: 3px solid rgba(233,138,122,.25); }
</style>