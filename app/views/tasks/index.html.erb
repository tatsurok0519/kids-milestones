<div class="container main">
  <!-- ヘッダー -->
  <div class="card" style="margin-bottom:1rem;">
    <% if user_signed_in? && current_child %>
      <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
        <% if current_child.photo.attached? %>
          <%= image_tag current_child.photo_card,
                alt: "#{current_child.name}の写真",
                style: "width:96px;height:96px;object-fit:cover;border-radius:12px;border:1px solid var(--border);" %>
        <% else %>
          <%= image_tag "illustrations/sun.png",
                alt: "", size: "96x96",
                style: "border-radius:12px;border:1px solid var(--border);background:#f3f4f6;" %>
        <% end %>

        <div style="min-width:200px;">
          <h2 class="h2" style="margin:0 0 .25rem 0;">できるかな（標準タスク）</h2>
          <div class="h2" style="font-size:1.1rem;margin:0;">
            <strong><%= current_child.name %></strong> さん
          </div>
          <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.25rem;">
            <span class="pill"><%= current_child.age_label %></span>
            <span class="pill"><%= current_child.age_band_label %></span>
          </div>
        </div>
      </div>

    <% elsif user_signed_in? %>
      <h2 class="h2" style="margin:0;">できるかな</h2>
      <p style="margin:.25rem 0 0;">
        子どもが未選択です。
        <%= link_to "子どもを追加", new_child_path, class: "btn btn-primary" %>
        <%= link_to "既存の子を選ぶ", children_path, class: "btn btn-secondary", style: "margin-left:.5rem;" %>
      </p>

    <% else %>
      <h2 class="h2" style="margin:0;">できるかな</h2>
      <p style="margin:.25rem 0 0;">
        ログインなしの「おためしモード」です。進捗はこの端末（ブラウザ）のみ保存されます。
        <%= link_to "保存やレポートを使うには登録", new_user_registration_path, class: "btn btn-primary", style: "margin-left:.5rem;" %>
      </p>
    <% end %>
  </div>

  <!-- 今日の子育てメッセージ -->
  <div class="card" style="margin:-.25rem 0 .75rem 0; border:1px solid #cce7ff; background:#f5fbff;">
    <div style="display:flex; gap:.6rem; align-items:flex-start;">
      <%= image_tag "illustrations/sun.png", alt: "", width: 24, height: 24,
            style: "flex:none; margin-top:.1rem;" %>
      <div>
        <div class="label" style="font-weight:700; margin-bottom:.2rem;">今日の子育てメッセージ</div>
        <div style="line-height:1.6;"><%= @parent_tip %></div>
      </div>
    </div>
  </div>

  <!-- フィルター -->
  <div class="card" style="padding:.75rem;margin-bottom:.75rem;">
    <%= form_with url: tasks_path, method: :get, local: true,
          html: { style: "display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;" } do %>

      <label class="label" for="age_band">年齢帯</label>
      <% age_band_options = [["すべて", "all"]] + (0..5).map { |i| ["#{i}–#{i+1}歳", i] } %>
      <%= select_tag :age_band,
            options_for_select(
              age_band_options,
              params.key?(:age_band) ? (params[:age_band] == "all" ? "all" : params[:age_band].to_i) : @age_band_index
            ),
            class: "input",
            onchange: "this.form.submit()" %>

      <label class="label" for="category">カテゴリ</label>
      <%= select_tag :category,
            options_for_select([["すべて", ""]] + @categories.map { |c| [c, c] }, params[:category].to_s),
            class: "input",
            onchange: "this.form.submit()" %>

      <label class="label" for="difficulty">難易度</label>
      <%= select_tag :difficulty,
            options_for_select([["すべて", ""]] + @difficulties, params[:difficulty].to_s),
            class: "input",
            onchange: "this.form.submit()" %>

      <!-- 未達成のみ -->
      <label class="label" for="only_unachieved" style="display:flex;align-items:center;gap:.35rem;">
        <%= check_box_tag :only_unachieved, "1", @only_unachieved,
              onchange: "this.form.submit()",
              disabled: !(user_signed_in? && current_child) %>
        未達成のみ
      </label>

      <% if current_user && current_child %>
        <span class="pill" style="margin-left:.25rem;">
          選択中：<strong><%= current_child.name %></strong>
          （<%= current_child.age_label %> / <%= current_child.age_band_label %>）
        </span>
      <% end %>
    <% end %>
  </div>

  <!-- 一覧 -->
  <div class="card">
    <% has_pager    = defined?(Kaminari) && @milestones.respond_to?(:current_page) %>
    <% total_count  = @milestones.respond_to?(:total_count) ? @milestones.total_count : @milestones.size %>
    <% total_pages  = has_pager ? @milestones.total_pages : 1 %>
    <% current_page = has_pager ? @milestones.current_page : 1 %>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;">
      <div class="h2" style="font-size:1.1rem;margin:0;">
        できるかな（<%= @age_band_label.presence || "全年齢" %>）
      </div>
      <div class="text-muted" style="font-size:.9rem;">
        該当 <%= total_count %> 件
        <% if has_pager %>（<%= current_page %>/<%= total_pages %>ページ）<% end %>
      </div>
    </div>

    <hr class="divider">

    <% if total_count.positive? %>
      <% if has_pager && total_pages > 1 %>
        <div style="margin:.25rem 0 .75rem;">
          <%= paginate @milestones, params: request.query_parameters %>
        </div>
      <% end %>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
        <% @milestones.each do |ms| %>
          <% ach = (defined?(@ach_by_ms) && @ach_by_ms) ? @ach_by_ms[ms.id] : nil %>

          <div class="milestone-card <%= 'is-working'  if ach&.working %> <%= 'is-achieved' if ach&.achieved %>"
               data-id="<%= ms.id %>"
               style="position:relative;border:1px solid var(--border);border-radius:.8rem;padding:.9rem;background:#fff;">

            <div style="font-weight:700;"><%= ms.title %></div>

            <div style="margin-top:.4rem;display:flex;gap:.4rem;align-items:center;flex-wrap:wrap;">
              <span class="pill"><%= ms.category.presence || "未分類" %></span>
              <span class="pill"><%= ms.age_band_labels %></span>
              <span class="pill"><%= ms.difficulty_stars %></span>
            </div>

            <% if user_signed_in? && current_child && !@demo_mode %>
              <!-- ログイン時：進捗コントロール（ヒントは置かない） -->
              <turbo-frame id="<%= dom_id(ms, :controls) %>">
                <%= render "tasks/controls", milestone: ms, achievement: ach %>
              </turbo-frame>
            <% else %>
              <!-- 未ログイン/デモ：右上バッジ（専用クラス） -->
              <div class="rw-badge-group" aria-hidden="true"
                   style="position:absolute; top:8px; right:8px; pointer-events:none;">
                <%= image_tag 'icons/try.png',      alt: '', class: 'rw-badge rw-badge-try',  width: 44, height: 44 %>
                <%= image_tag 'icons/hanamaru.png', alt: '', class: 'rw-badge rw-badge-achi', width: 44, height: 44 %>
              </div>

              <!-- 未ログイン/デモ：おためし進捗ボタン -->
              <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;">
                <button class="btn btn-secondary btn-working" type="button">がんばり中</button>
                <button class="btn btn-primary btn-achieved"  type="button">できた！</button>
              </div>
            <% end %>

            <%# ▼▼ 共通ヒント（どちらの状態でも1か所だけ） ▼▼ %>
            <% hint_html = milestone_hint_text(ms).presence %>
            <% if hint_html.present? %>
              <details class="hint-wrap" style="margin-top:.6rem;">
                <summary class="btn"
                        style="display:inline-flex; border:1px dashed var(--border); cursor:pointer; list-style:none;">
                  ヒント
                </summary>
                <div class="hint-box"
                    style="margin-top:.5rem; padding:.6rem; border:1px dashed var(--border);
                           border-radius:.6rem; background:#fffaf5; color:#7a4a00; font-size:.9rem;">
                  <%= hint_html %>
                </div>
              </details>
            <% end %>
            <%# ▲▲ 共通ヒントここまで ▲▲ %>

          </div>
        <% end %>
      </div>

      <% if has_pager && total_pages > 1 %>
        <div style="margin:.75rem 0 0;">
          <%= paginate @milestones, params: request.query_parameters %>
        </div>
      <% end %>

    <% else %>
      <p>該当タスクがありません。フィルター条件を変更してください。</p>
    <% end %>
  </div>
</div>

<%# ★ 未ログイン or デモモードのときだけ、デモ保存のJS/CSSを読み込む %>
<% if !user_signed_in? || @demo_mode %>
  <script>
  (function(){
    const KEY = "try_progress_v1";
    function loadState(){ try { return JSON.parse(localStorage.getItem(KEY) || "{}"); } catch(e){ return {}; } }
    function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function renderCard(card, rec){
      card.classList.remove("is-working","is-achieved");
      if (rec && rec.achieved)      { card.classList.add("is-achieved"); }
      else if (rec && rec.working)  { card.classList.add("is-working"); }
    }
    const state = loadState();
    document.querySelectorAll(".milestone-card").forEach(card => {
      const id = card.getAttribute("data-id");
      renderCard(card, state[id]);
      card.querySelector(".btn-working")?.addEventListener("click", () => {
        state[id] = state[id] || {};
        state[id].working = !state[id].working;
        if (state[id].working) state[id].achieved = false;
        renderCard(card, state[id]); saveState(state);
      });
      card.querySelector(".btn-achieved")?.addEventListener("click", () => {
        state[id] = state[id] || {};
        state[id].achieved = !state[id].achieved;
        if (state[id].achieved) state[id].working = false;
        renderCard(card, state[id]); saveState(state);
      });
    });
  })();
  </script>

  <style>
  /* TRY/花丸バッジ：状態クラスで表示切替（専用クラス） */
  .rw-badge { display: none; }
  .milestone-card.is-working  .rw-badge-try  { display: block; }
  .milestone-card.is-achieved .rw-badge-achi { display: block; }

  /* details/summary のデフォ三角を消す */
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }
  </style>
<% else %>
  <style>
  /* ログイン時にも details の三角を消す（CSSは共通で適用） */
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }
  </style>
<% end %>